# Create a fixed version where the GoToolOnline logo reliably returns to Home
# (preserves ?lang= in URL), keeping the robust IPv4 + JSONP code.

html = r"""<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IPv4 æŸ¥è¯¢ | GoToolOnline</title>
<meta name="description" content="æ˜¾ç¤ºä½ çš„å…¬ç½‘ IPv4ï¼ˆç‚¹åˆ†åè¿›åˆ¶ï¼‰åŠå¤§è‡´å½’å±åœ°ï¼ˆå›½å®¶/åŸå¸‚/è¿è¥å•†ï¼‰ã€‚é‡‡ç”¨å¤šä¾›åº”å•† + JSONP å…œåº•ï¼Œå°½é‡é¿å… CORS å°é”ã€‚"/>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text x='6' y='52' font-size='48'>ğŸ› ï¸</text></svg>"/>
<style>
:root{--bg:#0a0f1e;--card:#0f1830;--muted:#9fb0c3;--fg:#eaf3ff;--acc:#4fb3ff}
*{box-sizing:border-box}
body{margin:0;font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",sans-serif;background:var(--bg);color:var(--fg)}
main,header,footer{max-width:920px;margin:0 auto;padding:0 18px}
header{display:flex;gap:12px;align-items:center;margin:22px auto 8px}
header .logo{display:flex;gap:10px;align-items:center;text-decoration:none;color:var(--fg);font-weight:800;font-size:22px}
.lang{margin-left:auto;padding:10px 12px;background:#0f1a2f;border:1px solid #24365b;border-radius:10px;color:#eaf3ff;font-size:14px}
.card{background:var(--card);border:1px solid #1a2843;border-radius:18px;padding:18px;margin:16px 0}
h1{margin:6px 0 8px;font-size:28px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{padding:12px 14px;border-radius:12px;border:1px solid #24365b;background:linear-gradient(180deg,#2a78ff,#0050d4);color:#fff;font-weight:700;cursor:pointer}
button.secondary{background:#0f1a2f;color:#eaf3ff}
button:hover{filter:brightness(1.06)}
.result{margin-top:12px;padding:14px;background:#0c1426;border:1px dashed #2a3c64;border-radius:12px;font-size:20px;display:flex;justify-content:space-between;align-items:center;gap:10px}
.small{font-size:14px;color:var(--muted)}
.code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Cascadia Mono","Segoe UI Mono",Consolas,"Liberation Mono",monospace}
.copy{margin-left:auto;background:#0f1a2f;border:1px solid #24365b}
.tip{margin-top:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:10px}
.info{background:#0c1426;border:1px solid #24365b;border-radius:12px;padding:12px}
footer{color:var(--muted);font-size:14px;margin:36px auto 28px}
@media (max-width:720px){ .result{flex-direction:column;align-items:flex-start} .copy{margin-left:0} }
</style>
</head>
<body>
<header>
  <!-- data-home å°†åœ¨åº•éƒ¨è„šæœ¬é‡Œè¢«æ›¿æ¢ä¸ºæ­£ç¡®çš„é¦–é¡µé“¾æ¥ï¼ˆå¹¶è‡ªåŠ¨å¸¦ä¸Š ?lang=ï¼‰ -->
  <a class="logo" data-home href="#"><span>ğŸ› ï¸</span><strong>GoToolOnline</strong></a>
  <select id="lang" class="lang" aria-label="Language">
    <option value="zh">ç®€ä½“ä¸­æ–‡</option>
    <option value="en">English</option>
    <option value="ph">Tagalog</option>
    <option value="id">Bahasa Indonesia</option>
    <option value="vi">Tiáº¿ng Viá»‡t</option>
    <option value="bn">à¦¬à¦¾à¦‚à¦²à¦¾</option>
    <option value="ng">English (NG)</option>
    <option value="sw">Kiswahili</option>
    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
  </select>
</header>
<main>
  <section class="card">
    <h1 id="h1">IPv4 æŸ¥è¯¢ï¼ˆç‚¹åˆ†åè¿›åˆ¶ï¼‰</h1>
    <div class="row">
      <button id="btnV4">è·å–æˆ‘çš„ IPv4</button>
      <button id="btnCopy" class="copy">å¤åˆ¶</button>
      <button id="btnLan" class="secondary">å°è¯•è·å–å†…ç½‘ IPv4ï¼ˆå®éªŒï¼‰</button>
    </div>
    <div class="result">
      <span><span id="labelPublic">ä½ çš„ IPv4ï¼š</span> <strong id="ip" class="code">â€”</strong></span>
      <span class="small" id="copied" style="display:none">å·²å¤åˆ¶ï¼</span>
    </div>

    <div class="grid">
      <div class="info"><strong id="locLabel">å½’å±åœ°</strong><div class="small" id="loc">â€”</div></div>
      <div class="info"><strong id="ispLabel">ç½‘ç»œ/è¿è¥å•†</strong><div class="small" id="isp">â€”</div></div>
    </div>

    <p class="small tip" id="note">
      è¯´æ˜ï¼šæœ¬é¡µåªæ˜¾ç¤ºå…¬ç½‘ IPv4ï¼›è‹¥ä½ çš„ç½‘ç»œæ²¡æœ‰å…¬ç½‘ IPv4ï¼Œå¯èƒ½ä¼šå¤±è´¥ã€‚å½’å±åœ°ä»…ä¾›å‚è€ƒã€‚å·²å†…ç½®å¤šä¾›åº”å•†ä¸ JSONP å…œåº•ï¼Œå°½é‡é¿å… CORS é˜»æ‹¦ã€‚
    </p>

    <div class="card" style="margin-top:14px">
      <div class="small" id="lanTip">å†…ç½‘ IPï¼ˆå¦‚ 192.168.x.x / 10.x.x.x / 172.16â€“31.x.xï¼‰å—æµè§ˆå™¨éšç§ä¿æŠ¤ã€‚ä¸‹é¢æŒ‰é’®ç”¨ WebRTC è¯•æ¢ï¼ŒæˆåŠŸç‡ä¸ä¿è¯ã€‚</div>
      <div class="result" style="margin-top:10px">
        <span><span id="labelLan">å†…ç½‘ IPv4ï¼ˆå®éªŒï¼‰ï¼š</span> <strong id="lan" class="code">â€”</strong></span>
      </div>
    </div>
  </section>
</main>
<footer>Â© 2025 GoToolOnline.com</footer>

<script>
// ===== i18n (9 languages) =====
const I18N = {
  zh:{title:"IPv4 æŸ¥è¯¢ | GoToolOnline",desc:"æ˜¾ç¤ºä½ çš„å…¬ç½‘ IPv4ï¼ˆç‚¹åˆ†åè¿›åˆ¶ï¼‰åŠå¤§è‡´å½’å±åœ°ï¼ˆå›½å®¶/åŸå¸‚/è¿è¥å•†ï¼‰ã€‚",h1:"IPv4 æŸ¥è¯¢ï¼ˆç‚¹åˆ†åè¿›åˆ¶ï¼‰",btnV4:"è·å–æˆ‘çš„ IPv4",btnCopy:"å¤åˆ¶",btnLan:"å°è¯•è·å–å†…ç½‘ IPv4ï¼ˆå®éªŒï¼‰",labelPublic:"ä½ çš„ IPv4ï¼š",labelLan:"å†…ç½‘ IPv4ï¼ˆå®éªŒï¼‰ï¼š",copied:"å·²å¤åˆ¶ï¼",querying:"æŸ¥è¯¢ä¸­â€¦",noipv4:"æœªè·å–åˆ°å…¬ç½‘ IPv4",lanTry:"å°è¯•ä¸­â€¦",lanFail:"æœªè·å–åˆ°ï¼ˆæµè§ˆå™¨å·²å±è”½ï¼‰",note:"æœ¬é¡µä»…æ˜¾ç¤ºå…¬ç½‘ IPv4ï¼›è‹¥ä½ çš„ç½‘ç»œæ²¡æœ‰å…¬ç½‘ IPv4ï¼Œå¯èƒ½ä¼šå¤±è´¥ã€‚å½’å±åœ°ä»…ä¾›å‚è€ƒã€‚",loc:"å½’å±åœ°",isp:"ç½‘ç»œ/è¿è¥å•†",lanTip:"å†…ç½‘ IP å—æµè§ˆå™¨éšç§ä¿æŠ¤ï¼›ä¸‹æ–¹æŒ‰é’®ç”¨ WebRTC è¯•æ¢ï¼Œä¸ä¿è¯æˆåŠŸã€‚"},
  en:{title:"IPv4 Lookup | GoToolOnline",desc:"Show your public IPv4 and rough geolocation (country/city/ISP).",h1:"IPv4 Lookup (Dotted Decimal)",btnV4:"Show My IPv4",btnCopy:"Copy",btnLan:"Try Local IPv4 (Experimental)",labelPublic:"Your IPv4:",labelLan:"Local IPv4 (Experimental):",copied:"Copied!",querying:"Checkingâ€¦",noipv4:"Couldn't get public IPv4",lanTry:"Tryingâ€¦",lanFail:"Not available (blocked by browser)",note:"Public IPv4 only; if your network has none, this may fail. Location is approximate.",loc:"Location",isp:"Network / ISP",lanTip:"Local/private IPv4 is hidden by browsers; WebRTC attempt only."},
  ph:{title:"IPv4 Lookup | GoToolOnline",desc:"Ipakita ang public IPv4 at lokasyon (bansa/lungsod/ISP).",h1:"IPv4 Lookup (Dotted Decimal)",btnV4:"Ipakita ang Aking IPv4",btnCopy:"Kopyahin",btnLan:"Subukan ang Local IPv4 (Experimental)",labelPublic:"IP mo (IPv4):",labelLan:"Local IPv4 (Experimental):",copied:"Nakopya!",querying:"Sinusuriâ€¦",noipv4:"Hindi nakuha ang public IPv4",lanTry:"Sinusubukanâ€¦",lanFail:"Hindi makuha (hinarang ng browser)",note:"Public IPv4 lang; kung wala, puwedeng mag-fail. Lokasyon ay tantya.",loc:"Lokasyon",isp:"Network / ISP",lanTip:"Local IPv4 ay nakatago ng browser; sumusubok lang gamit ang WebRTC."},
  id:{title:"Pencari IPv4 | GoToolOnline",desc:"Tampilkan IPv4 publik dan lokasi (negara/kota/ISP).",h1:"Pencari IPv4 (Dotted Decimal)",btnV4:"Tampilkan IPv4 Saya",btnCopy:"Salin",btnLan:"Coba IPv4 Lokal (Eksperimental)",labelPublic:"IPv4 Anda:",labelLan:"IPv4 Lokal (Eksperimental):",copied:"Disalin!",querying:"Memeriksaâ€¦",noipv4:"Gagal mendapatkan IPv4 publik",lanTry:"Mencobaâ€¦",lanFail:"Tidak tersedia (diblokir browser)",note:"Hanya IPv4 publik; jika jaringan tidak punya, bisa gagal. Lokasi perkiraan.",loc:"Lokasi",isp:"Jaringan / ISP",lanTip:"IPv4 lokal disembunyikan; hanya percobaan WebRTC."},
  vi:{title:"Tra cá»©u IPv4 | GoToolOnline",desc:"Hiá»ƒn thá»‹ IPv4 cÃ´ng cá»™ng vÃ  vá»‹ trÃ­ (quá»‘c gia/thÃ nh phá»‘/ISP).",h1:"Tra cá»©u IPv4 (Dotted Decimal)",btnV4:"Hiá»‡n IPv4 cá»§a tÃ´i",btnCopy:"Sao chÃ©p",btnLan:"Thá»­ IPv4 ná»™i bá»™ (thá»­ nghiá»‡m)",labelPublic:"IPv4 cá»§a báº¡n:",labelLan:"IPv4 ná»™i bá»™ (thá»­ nghiá»‡m):",copied:"ÄÃ£ sao chÃ©p!",querying:"Äang kiá»ƒm traâ€¦",noipv4:"KhÃ´ng láº¥y Ä‘Æ°á»£c IPv4 cÃ´ng cá»™ng",lanTry:"Äang thá»­â€¦",lanFail:"KhÃ´ng thá»ƒ láº¥y (trÃ¬nh duyá»‡t cháº·n)",note:"Chá»‰ hiá»ƒn thá»‹ IPv4 cÃ´ng cá»™ng; náº¿u máº¡ng khÃ´ng cÃ³ thÃ¬ cÃ³ thá»ƒ lá»—i. Vá»‹ trÃ­ Æ°á»›c lÆ°á»£ng.",loc:"Vá»‹ trÃ­",isp:"Máº¡ng / ISP",lanTip:"IPv4 ná»™i bá»™ bá»‹ áº©n; chá»‰ thá»­ qua WebRTC."},
  bn:{title:"IPv4 à¦…à¦¨à§à¦¸à¦¨à§à¦§à¦¾à¦¨ | GoToolOnline",desc:"à¦ªà¦¾à¦¬à¦²à¦¿à¦• IPv4 à¦“ à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨ (à¦¦à§‡à¦¶/à¦¶à¦¹à¦°/ISP) à¦¦à§‡à¦–à¦¾à¦¯à¦¼à¥¤",h1:"IPv4 à¦…à¦¨à§à¦¸à¦¨à§à¦§à¦¾à¦¨ (Dotted Decimal)",btnV4:"à¦†à¦®à¦¾à¦° IPv4 à¦¦à§‡à¦–à¦¾à¦¨",btnCopy:"à¦•à¦ªà¦¿",btnLan:"à¦²à§‹à¦•à¦¾à¦² IPv4 à¦šà§‡à¦·à§à¦Ÿà¦¾ (à¦ªà¦°à§€à¦•à§à¦·à¦¾à¦®à§‚à¦²à¦•)",labelPublic:"à¦†à¦ªà¦¨à¦¾à¦° IPv4:",labelLan:"à¦²à§‹à¦•à¦¾à¦² IPv4 (à¦ªà¦°à§€à¦•à§à¦·à¦¾à¦®à§‚à¦²à¦•):",copied:"à¦•à¦ªà¦¿ à¦¹à¦¯à¦¼à§‡à¦›à§‡!",querying:"à¦šà§‡à¦• à¦•à¦°à¦¾ à¦¹à¦šà§à¦›à§‡â€¦",noipv4:"à¦ªà¦¾à¦¬à¦²à¦¿à¦• IPv4 à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿",lanTry:"à¦šà§‡à¦·à§à¦Ÿà¦¾ à¦šà¦²à¦›à§‡â€¦",lanFail:"à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿ (à¦¬à§à¦°à¦¾à¦‰à¦œà¦¾à¦° à¦¬à§à¦²à¦• à¦•à¦°à§‡à¦›à§‡)",note:"à¦¶à§à¦§à§ à¦ªà¦¾à¦¬à¦²à¦¿à¦• IPv4; à¦¨à¦¾ à¦¥à¦¾à¦•à¦²à§‡ à¦¬à§à¦¯à¦°à§à¦¥ à¦¹à¦¤à§‡ à¦ªà¦¾à¦°à§‡à¥¤ à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨ à¦†à¦¨à§à¦®à¦¾à¦¨à¦¿à¦•à¥¤",loc:"à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨",isp:"à¦¨à§‡à¦Ÿà¦“à¦¯à¦¼à¦¾à¦°à§à¦• / ISP",lanTip:"à¦²à§‹à¦•à¦¾à¦² IPv4 à¦²à§à¦•à¦¾à¦¨à§‹; WebRTC à¦¦à¦¿à¦¯à¦¼à§‡ à¦šà§‡à¦·à§à¦Ÿà¦¾à¥¤"},
  ng:{title:"IPv4 Lookup | GoToolOnline",desc:"Show your public IPv4 and rough location (country/city/ISP).",h1:"IPv4 Lookup (Dotted Decimal)",btnV4:"Show My IPv4",btnCopy:"Copy",btnLan:"Try Local IPv4 (Experimental)",labelPublic:"Your IPv4:",labelLan:"Local IPv4 (Experimental):",copied:"Copied!",querying:"Checkingâ€¦",noipv4:"No public IPv4",lanTry:"Tryingâ€¦",lanFail:"No show (browser block am)",note:"Public IPv4 only; if no get am, fit fail. Location approx.",loc:"Location",isp:"Network / ISP",lanTip:"Local IPv4 dey hidden; WebRTC trial only."},
  sw:{title:"Utafutaji wa IPv4 | GoToolOnline",desc:"Onyesha IPv4 ya umma na eneo (nchi/jiji/ISP).",h1:"Utafutaji wa IPv4 (Dotted Decimal)",btnV4:"Onyesha IPv4 Yangu",btnCopy:"Nakili",btnLan:"Jaribu IPv4 ya Ndani (Majaribio)",labelPublic:"IPv4 yako:",labelLan:"IPv4 ya Ndani (Majaribio):",copied:"Imenakiliwa!",querying:"Inakaguliwaâ€¦",noipv4:"Haijapata IPv4 ya umma",lanTry:"Inajaribuâ€¦",lanFail:"Haipatikani (imezuiwa na kivinjari)",note:"IPv4 ya umma pekee; kama huna, inaweza kukosa. Eneo la kukadiria.",loc:"Eneo",isp:"Mtandao / ISP",lanTip:"IPv4 ya ndani imefichwa; jaribio la WebRTC pekee."},
  ar:{title:"Ø¨Ø­Ø« IPv4 | GoToolOnline",desc:"Ø§Ø¹Ø±Ø¶ IPv4 Ø§Ù„Ø¹Ø§Ù… ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ù„Ø¨Ù„Ø¯/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©).",h1:"Ø¨Ø­Ø« IPv4 (ØµÙŠØºØ© Ø§Ù„Ù†Ù‚Ø§Ø·)",btnV4:"Ø§Ø¹Ø±Ø¶ IPv4 Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ",btnCopy:"Ù†Ø³Ø®",btnLan:"Ù…Ø­Ø§ÙˆÙ„Ø© IPv4 Ø§Ù„Ù…Ø­Ù„ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ)",labelPublic:"Ø¹Ù†ÙˆØ§Ù† IPv4 Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:",labelLan:"IPv4 Ø§Ù„Ù…Ø­Ù„ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ):",copied:"ØªÙ… Ø§Ù„Ù†Ø³Ø®!",querying:"Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦",noipv4:"ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IPv4 Ø§Ù„Ø¹Ø§Ù…",lanTry:"Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©â€¦",lanFail:"ØºÙŠØ± Ù…ØªØ§Ø­ (Ø­Ø¬Ø¨Ù‡ Ø§Ù„Ù…ØªØµÙØ­)",note:"IPv4 Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø·Ø› Ø¥Ù† Ù„Ù… ÙŠØªÙˆÙØ± ÙÙ‚Ø¯ ØªÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ‚Ø±ÙŠØ¨ÙŠ.",loc:"Ø§Ù„Ù…ÙˆÙ‚Ø¹",isp:"Ø§Ù„Ø´Ø¨ÙƒØ© / Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©",lanTip:"Ø¹Ù†ÙˆØ§Ù† IPv4 Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…Ø®ÙÙŠØ› Ù…Ø­Ø§ÙˆÙ„Ø© WebRTC ÙÙ‚Ø·."}
};

function mapHtmlLang(lang){
  if (lang === 'ph') return 'fil';
  if (lang === 'zh') return 'zh-CN';
  if (lang === 'ng') return 'en-NG';
  return lang;
}

const IPV4_RE=/^(?:(?:25[0-5]|2[0-4]\\d|1?\\d?\\d)\\.){3}(?:25[0-5]|2[0-4]\\d|1?\\d?\\d)$/;
const $=s=>document.querySelector(s);
const TIMEOUT=6000;

function tkey(key){ const lang=$('#lang').value; return (I18N[lang]||I18N.zh)[key]||I18N.zh[key]||key; }
function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }

function applyLang(lang){
  const d=I18N[lang]||I18N.zh;
  document.title=d.title; const md=document.querySelector('meta[name="description"]'); if(md) md.setAttribute('content', d.desc);
  document.documentElement.lang=mapHtmlLang(lang);
  document.documentElement.dir=(lang==='ar')?'rtl':'ltr';
  $('#lang').value=lang;
  setText('h1', d.h1); setText('btnV4', d.btnV4); setText('btnCopy', d.btnCopy); setText('btnLan', d.btnLan);
  setText('labelPublic', d.labelPublic); setText('labelLan', d.labelLan);
  setText('note', d.note); setText('locLabel', d.loc); setText('ispLabel', d.isp); setText('lanTip', d.lanTip);
  // persist + keep URL
  localStorage.setItem('lang', lang);
  const qs=new URLSearchParams(location.search); qs.set('lang', lang);
  history.replaceState({},'',location.pathname+'?'+qs.toString());
}

function bootLang(){
  const qs=new URLSearchParams(location.search);
  const fromQS=qs.get('lang'); const fromLS=localStorage.getItem('lang');
  const lang = I18N[fromQS]?fromQS:(I18N[fromLS]?fromLS:'zh');
  applyLang(lang);
}

// ---- Fetch helpers ----
function fetchJSON(url){
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), TIMEOUT);
  return fetch(url,{signal:ctrl.signal,cache:'no-store'})
    .then(r=>{ if(!r.ok) throw new Error('http '+r.status); return r.json(); })
    .finally(()=>clearTimeout(t));
}

// JSONP helper
function jsonp(url, timeout=TIMEOUT){
  return new Promise((resolve, reject)=>{
    const cb='__jp'+Math.random().toString(36).slice(2);
    const clean=()=>{ delete window[cb]; if(s.parentNode) s.parentNode.removeChild(s); if(timer) clearTimeout(timer); };
    window[cb]=(data)=>{ clean(); resolve(data); };
    const s=document.createElement('script');
    s.src = url.replace(/callback=[^&]*/,'').replace(/\?$/,'') + (url.includes('?')?'&':'?') + 'callback=' + cb;
    s.onerror=()=>{ clean(); reject(new Error('jsonp error')); };
    document.head.appendChild(s);
    const timer=setTimeout(()=>{ clean(); reject(new Error('jsonp timeout')); }, timeout);
  });
}

// Try providers in order until one works and returns IPv4
async function getIPv4(){
  try{
    const d = await fetchJSON('https://api4.ipify.org?format=json');
    if (d && IPV4_RE.test(String(d.ip||''))) return String(d.ip);
  }catch(e){}
  try{
    const d = await jsonp('https://api4.ipify.org?format=jsonp');
    if (d && IPV4_RE.test(String(d.ip||''))) return String(d.ip);
  }catch(e){}
  try{
    const d = await jsonp('https://ipv4.ipapi.co/json/');
    if (d && IPV4_RE.test(String(d.ip||''))) return String(d.ip);
  }catch(e){}
  try{
    const d = await jsonp('https://ip-api.com/json/?fields=status,message,query');
    if (d && d.status==='success' && IPV4_RE.test(String(d.query||''))) return String(d.query);
  }catch(e){}
  throw new Error('no ipv4');
}

// Geo by IP
async function geoByIP(ip){
  try{
    const f='status,country,regionName,city,isp';
    const d = await jsonp('https://ip-api.com/json/'+encodeURIComponent(ip)+'?fields='+encodeURIComponent(f));
    if (d && d.status==='success'){
      return {country:d.country||'',region:d.regionName||'',city:d.city||'',org:d.isp||''};
    }
  }catch(e){}
  try{
    const d = await jsonp('https://ipv4.ipapi.co/'+encodeURIComponent(ip)+'/json/');
    return {country:d.country_name||'',region:d.region||'',city:d.city||'',org:d.org||d.org_name||''};
  }catch(e){}
  return null;
}

// UI actions
async function fetchIPv4AndGeo(){
  setText('ip', tkey('querying')); setText('loc','â€”'); setText('isp','â€”');
  try{
    const ip = await getIPv4();
    setText('ip', ip);
    try{
      const g = await geoByIP(ip);
      if (g){
        const pieces = [g.country, g.region, g.city].filter(Boolean);
        setText('loc', pieces.length ? pieces.join(', ') : 'â€”');
        setText('isp', g.org || 'â€”');
      }
    }catch(e){}
  }catch(e){
    setText('ip', tkey('noipv4'));
  }
}

function copyIPv4(){
  const v=($('#ip').textContent||'').trim();
  if(!IPV4_RE.test(v)) return;
  navigator.clipboard?.writeText(v).then(()=>{
    const el=$('#copied'); el.textContent = tkey('copied'); el.style.display='';
    setTimeout(()=>el.style.display='none', 1200);
  }).catch(()=>{});
}

// Experimental local IPv4 via WebRTC
async function detectLAN(){
  setText('lan', tkey('lanTry'));
  try{
    const pc=new RTCPeerConnection({iceServers:[]});
    pc.createDataChannel('x');
    const found=new Set();
    const stop=()=>{ try{pc.close();}catch(e){} };
    const timer=setTimeout(()=>{ stop(); if($('#lan').textContent===tkey('lanTry')) setText('lan', tkey('lanFail')); }, 7000);

    pc.onicecandidate=(e)=>{
      if(!e.candidate) return;
      const c=e.candidate.candidate||'';
      if(!/ typ host\\b/.test(c)) return;
      const m=c.match(/(\\d{1,3}(?:\\.\\d{1,3}){3})/);
      if(!m) return;
      const ip=m[1];
      if(!IPV4_RE.test(ip)) return;
      if(/^10\\./.test(ip) || /^192\\.168\\./.test(ip) || /^172\\.(1[6-9]|2\\d|3[0-1])\\./.test(ip)){
        if(!found.has(ip)){
          found.add(ip);
          setText('lan', ip);
          clearTimeout(timer);
          stop();
        }
      }
    };
    const sdp=await pc.createOffer({offerToReceiveAudio:false,offerToReceiveVideo:false});
    await pc.setLocalDescription(sdp);
  }catch(e){
    setText('lan', tkey('lanFail'));
  }
}

// Wire up
bootLang();
document.getElementById('lang').addEventListener('change', e=>applyLang(e.target.value));
document.getElementById('btnV4').addEventListener('click', fetchIPv4AndGeo);
document.getElementById('btnCopy').addEventListener('click', copyIPv4);
document.getElementById('btnLan').addEventListener('click', detectLAN);

// Auto run on load
fetchIPv4AndGeo();

// ===== ä¿®å¤â€œè¿”å›é¦–é¡µâ€é“¾æ¥ï¼šè‡ªåŠ¨è®¡ç®—ä¸Šçº§ç›®å½•å¹¶é€ä¼  ?lang =====
(function(){
  // å»æ‰æœ«å°¾æ–œæ ï¼Œæ‹†åˆ†è·¯å¾„
  var path = location.pathname.replace(/\/+$/,'');
  var parts = path.split('/');
  // å‡è®¾å·¥å…·é¡µæ˜¯ /category/tool/ è¿™æ ·çš„ä¸¤çº§ç›®å½•ï¼Œå›åˆ°ç«™ç‚¹æ ¹ï¼šå»æ‰æœ€åä¸¤æ®µ
  if (parts.length >= 3) parts = parts.slice(0, parts.length - 2);
  else parts = [''];
  var home = parts.join('/') + '/';

  // é€ä¼  ?lang
  var cur = new URL(location.href);
  var lang = cur.searchParams.get('lang') || localStorage.getItem('lang');
  if (lang) {
    var u = new URL(home, location.origin);
    u.searchParams.set('lang', lang);
    home = u.pathname + u.search + u.hash;
  }

  document.querySelectorAll('a[data-home]').forEach(function(a){
    a.setAttribute('href', home);
  });
})();
</script>
</body>
</html>
"""
path = "/mnt/data/ip-address-ipv4-9langs-geo-jsonp-homefix.html"
with open(path, "w", encoding="utf-8") as f:
    f.write(html)
path
