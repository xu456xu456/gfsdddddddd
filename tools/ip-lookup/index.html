<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IPv4/IPv6 æŸ¥è¯¢ | GoToolOnline</title>
<meta name="description" content="åŒæ—¶æ˜¾ç¤ºä½ çš„å…¬ç½‘ IPv4 å’Œ IPv6ï¼Œå¹¶é™„åœ°ç†å½’å±ï¼ˆå›½å®¶/åœ°åŒº/åŸå¸‚/è¿è¥å•†ï¼‰ã€‚å¤šä¾›åº”å•† + å¹¶è¡Œå…œåº•ï¼Œå°½é‡é¿å…è¯·æ±‚å¤±è´¥ã€‚"/>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text x='6' y='52' font-size='48'>ğŸ› ï¸</text></svg>"/>
<style>
:root{--bg:#0a0f1e;--card:#0f1830;--muted:#9fb0c3;--fg:#eaf3ff;--acc:#4fb3ff}
*{box-sizing:border-box}
body{margin:0;font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",sans-serif;background:var(--bg);color:var(--fg)}
main,header,footer{max-width:980px;margin:0 auto;padding:0 18px}
header{display:flex;gap:12px;align-items:center;margin:22px auto 8px}
header .logo{display:flex;gap:10px;align-items:center;text-decoration:none;color:var(--fg);font-weight:800;font-size:22px}
.lang{margin-left:auto;padding:10px 12px;background:#0f1a2f;border:1px solid #24365b;border-radius:10px;color:var(--fg);font-size:14px}
.card{background:var(--card);border:1px solid #1a2843;border-radius:18px;padding:18px;margin:16px 0}
h1{margin:6px 0 8px;font-size:28px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{padding:12px 14px;border-radius:12px;border:1px solid #24365b;background:linear-gradient(180deg,#2a78ff,#0050d4);color:#fff;font-weight:700;cursor:pointer}
button.secondary{background:#0f1a2f;color:var(--fg)}
button:hover{filter:brightness(1.06)}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:10px}
@media (max-width:800px){ .grid2{grid-template-columns:1fr} }
.panel{background:#0c1426;border:1px solid #2a3c64;border-radius:14px;padding:14px}
.kv{display:flex;justify-content:space-between;align-items:center;gap:10px}
.addr{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Cascadia Mono","Segoe UI Mono",Consolas,"Liberation Mono",monospace;font-size:20px}
.small{font-size:14px;color:var(--muted)}
.copy{background:#0f1a2f;border:1px solid #24365b}
footer{color:var(--muted);font-size:14px;margin:36px auto 28px}
hr{border:none;height:1px;background:#223357;margin:10px 0}
.flag{font-size:1.1rem;margin-right:.35rem}
</style>
</head>
<body>
<header>
  <a class="logo" data-home href="#"><span>ğŸ› ï¸</span><strong>GoToolOnline</strong></a>
  <select id="lang" class="lang" aria-label="Language">
    <option value="zh">ç®€ä½“ä¸­æ–‡</option>
    <option value="en">English</option>
    <option value="ph">Tagalog</option>
    <option value="id">Bahasa Indonesia</option>
    <option value="vi">Tiáº¿ng Viá»‡t</option>
    <option value="bn">à¦¬à¦¾à¦‚à¦²à¦¾</option>
    <option value="ng">English (NG)</option>
    <option value="sw">Kiswahili</option>
    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
  </select>
</header>
<main>
  <section class="card">
    <h1 id="h1">IPv4 / IPv6 æŸ¥è¯¢</h1>
    <div class="row">
      <button id="btnBoth">æ˜¾ç¤ºæˆ‘çš„ IPï¼ˆv4+v6ï¼‰</button>
      <button id="btnCopy4" class="copy">å¤åˆ¶ IPv4</button>
      <button id="btnCopy6" class="copy">å¤åˆ¶ IPv6</button>
      <button id="btnLan" class="secondary">å°è¯•è·å–å†…ç½‘ IPv4ï¼ˆå®éªŒï¼‰</button>
    </div>

    <div class="grid2">
      <div class="panel">
        <div class="kv">
          <strong id="labelV4">å…¬ç½‘ IPv4</strong>
          <span class="small" id="copied4" style="display:none">å·²å¤åˆ¶ï¼</span>
        </div>
        <div class="kv" style="margin-top:6px">
          <span id="ip4" class="addr">â€”</span>
        </div>
        <hr/>
        <div class="small" id="geo4"><span id="flag4" class="flag">ğŸ³ï¸</span><span id="geo4txt">â€”</span></div>
      </div>

      <div class="panel">
        <div class="kv">
          <strong id="labelV6">å…¬ç½‘ IPv6</strong>
          <span class="small" id="copied6" style="display:none">å·²å¤åˆ¶ï¼</span>
        </div>
        <div class="kv" style="margin-top:6px">
          <span id="ip6" class="addr">â€”</span>
        </div>
        <hr/>
        <div class="small" id="geo6"><span id="flag6" class="flag">ğŸ³ï¸</span><span id="geo6txt">â€”</span></div>
      </div>
    </div>

    <div class="panel" style="margin-top:14px">
      <div class="kv"><strong id="labelLan">å†…ç½‘ IPv4ï¼ˆå®éªŒï¼‰</strong></div>
      <div class="kv" style="margin-top:6px"><span id="lan" class="addr">â€”</span></div>
      <div class="small" id="lanTip" style="margin-top:8px">æ³¨ï¼šæµè§ˆå™¨é€šå¸¸éšè—å†…ç½‘ IPï¼›æ­¤ä¸º WebRTC è¯•æ¢ï¼ŒæˆåŠŸç‡ä¸ä¿è¯ã€‚</div>
    </div>

    <p class="small" id="note" style="margin-top:12px">
      è¯´æ˜ï¼šå¦‚æœä½ çš„ç½‘ç»œæ²¡æœ‰å…¬ç½‘ IPv4 æˆ– IPv6ï¼Œåˆ™å¯¹åº”ä¸€ä¾§å¯èƒ½æ‹¿ä¸åˆ°ã€‚åœ°ç†ä¿¡æ¯ä¸º IP å¤§è‡´å½’å±ï¼Œä»…ä¾›å‚è€ƒã€‚
    </p>
  </section>
</main>
<footer>Â© 2025 GoToolOnline.com</footer>

<script>
/* ===================== åŸºç¡€å·¥å…· ===================== */
const $ = (s)=>document.querySelector(s);
const TIMEOUT = 3500;
const IPV4_RE=/^(?:(?:25[0-5]|2[0-4]\\d|1?\\d?\\d)\\.){3}(?:25[0-5]|2[0-4]\\d|1?\\d?\\d)$/;
const IPV6_RE=/^[0-9a-fA-F:]+$/;
const CFG = {
  ipinfoToken: "630a161186a234", // âœ… ä½ çš„ token
  ipapiKey: ""                   // å¯ç•™ç©ºï¼›æœ‰çš„è¯æ›´ç¨³
};

function abortableFetchJSON(url, ms=TIMEOUT){
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), ms);
  return fetch(url, {signal:ctrl.signal, cache:'no-store'})
    .then(r=>{ if(!r.ok) throw new Error('http '+r.status); return r.json(); })
    .finally(()=>clearTimeout(t));
}
const timeout = (ms)=>new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms));
const any = (arr)=>Promise.any(arr);

/* å›½æ—— emoji */
function ccToFlag(cc){
  if(!cc) return 'ğŸ³ï¸';
  return cc.toUpperCase().replace(/./g,c=>String.fromCodePoint(127397+c.charCodeAt()));
}

/* ===================== è¯­è¨€ ===================== */
const I18N = {
  zh:{title:"IPv4/IPv6 æŸ¥è¯¢ | GoToolOnline",desc:"åŒæ—¶æ˜¾ç¤ºä½ çš„å…¬ç½‘ IPv4 å’Œ IPv6ï¼Œå¹¶é™„åœ°ç†å½’å±ï¼ˆå›½å®¶/åœ°åŒº/åŸå¸‚/è¿è¥å•†ï¼‰ã€‚",h1:"IPv4 / IPv6 æŸ¥è¯¢",
      btnBoth:"æ˜¾ç¤ºæˆ‘çš„ IPï¼ˆv4+v6ï¼‰",btnCopy4:"å¤åˆ¶ IPv4",btnCopy6:"å¤åˆ¶ IPv6",btnLan:"å°è¯•è·å–å†…ç½‘ IPv4ï¼ˆå®éªŒï¼‰",
      v4:"å…¬ç½‘ IPv4", v6:"å…¬ç½‘ IPv6", lan:"å†…ç½‘ IPv4ï¼ˆå®éªŒï¼‰",
      copied:"å·²å¤åˆ¶ï¼", checking:"æŸ¥è¯¢ä¸­â€¦", no4:"æœªè·å–åˆ°å…¬ç½‘ IPv4ï¼ˆç§»åŠ¨ç½‘ç»œ/CGNAT å¸¸è§ï¼‰", no6:"æœªè·å–åˆ°å…¬ç½‘ IPv6",
      note:"å¦‚æœä½ çš„ç½‘ç»œæ²¡æœ‰å…¬ç½‘ IPv4 æˆ– IPv6ï¼Œåˆ™å¯¹åº”ä¸€ä¾§å¯èƒ½æ‹¿ä¸åˆ°ã€‚åœ°ç†ä¿¡æ¯ä¸º IP å¤§è‡´å½’å±ï¼Œä»…ä¾›å‚è€ƒã€‚",
      lanTip:"æµè§ˆå™¨é€šå¸¸éšè—å†…ç½‘ IPï¼›æ­¤ä¸º WebRTC è¯•æ¢ï¼ŒæˆåŠŸç‡ä¸ä¿è¯ã€‚", lanTrying:"å°è¯•ä¸­â€¦", lanFail:"æœªè·å–åˆ°ï¼ˆæµè§ˆå™¨å·²å±è”½ï¼‰"
  },
  en:{title:"IPv4/IPv6 Lookup | GoToolOnline",desc:"Show your public IPv4 and IPv6 with geolocation (country/region/city/ISP).",h1:"IPv4 / IPv6 Lookup",
      btnBoth:"Show My IPs (v4+v6)",btnCopy4:"Copy IPv4",btnCopy6:"Copy IPv6",btnLan:"Try Local IPv4 (Experimental)",
      v4:"Public IPv4", v6:"Public IPv6", lan:"Local IPv4 (Experimental)",
      copied:"Copied!", checking:"Checkingâ€¦", no4:"No public IPv4 (mobile/CGNAT common)", no6:"No public IPv6",
      note:"If your network lacks public IPv4/IPv6, the corresponding side may be empty. Location is approximate.",
      lanTip:"Browsers hide local IP; WebRTC probe only.", lanTrying:"Tryingâ€¦", lanFail:"Not available (blocked by browser)"
  },
  ph:{title:"IPv4/IPv6 Lookup | GoToolOnline",desc:"Ipakita ang public IPv4 at IPv6 at lokasyon (bansa/relo/ISP).",h1:"IPv4 / IPv6 Lookup",
      btnBoth:"Ipakita ang Aking IP (v4+v6)",btnCopy4:"Kopya IPv4",btnCopy6:"Kopya IPv6",btnLan:"Subukan ang Local IPv4 (Experimental)",
      v4:"Public IPv4", v6:"Public IPv6", lan:"Local IPv4 (Experimental)",
      copied:"Nakopya!", checking:"Sinusuriâ€¦", no4:"Hindi nakuha ang public IPv4", no6:"Hindi nakuha ang public IPv6",
      note:"Kung walang public IPv4/IPv6 sa network mo, puwedeng walang lalabas.", 
      lanTip:"Itinatago ng browser ang local IP; WebRTC lang ito.", lanTrying:"Sinusubukanâ€¦", lanFail:"Hindi makuha (hinarang ng browser)"
  },
  id:{title:"Pencari IPv4/IPv6 | GoToolOnline",desc:"Tampilkan IPv4 & IPv6 publik beserta lokasi (negara/wilayah/kota/ISP).",h1:"Pencari IPv4 / IPv6",
      btnBoth:"Tampilkan IP Saya (v4+v6)",btnCopy4:"Salin IPv4",btnCopy6:"Salin IPv6",btnLan:"Coba IPv4 Lokal (Eksperimental)",
      v4:"IPv4 Publik", v6:"IPv6 Publik", lan:"IPv4 Lokal (Eksperimental)",
      copied:"Disalin!", checking:"Memeriksaâ€¦", no4:"Tidak mendapatkan IPv4 publik (umum pada jaringan seluler/CGNAT)", no6:"Tidak mendapatkan IPv6 publik",
      note:"Jika jaringanmu tidak punya IPv4/IPv6 publik, sisi itu bisa kosong.",
      lanTip:"Browser menyembunyikan IP lokal; hanya uji WebRTC.", lanTrying:"Mencobaâ€¦", lanFail:"Tidak tersedia (diblokir browser)"
  },
  vi:{title:"Tra cá»©u IPv4/IPv6 | GoToolOnline",desc:"Hiá»ƒn thá»‹ IPv4 & IPv6 cÃ´ng cá»™ng cÃ¹ng vá»‹ trÃ­ (quá»‘c gia/vÃ¹ng/thÃ nh phá»‘/ISP).",h1:"Tra cá»©u IPv4 / IPv6",
      btnBoth:"Hiá»‡n IP cá»§a tÃ´i (v4+v6)",btnCopy4:"Sao chÃ©p IPv4",btnCopy6:"Sao chÃ©p IPv6",btnLan:"Thá»­ IPv4 ná»™i bá»™ (thá»­ nghiá»‡m)",
      v4:"IPv4 cÃ´ng cá»™ng", v6:"IPv6 cÃ´ng cá»™ng", lan:"IPv4 ná»™i bá»™ (thá»­ nghiá»‡m)",
      copied:"ÄÃ£ sao chÃ©p!", checking:"Äang kiá»ƒm traâ€¦", no4:"KhÃ´ng láº¥y Ä‘Æ°á»£c IPv4 cÃ´ng khai (máº¡ng di Ä‘á»™ng/CGNAT thÆ°á»ng gáº·p)", no6:"KhÃ´ng láº¥y Ä‘Æ°á»£c IPv6 cÃ´ng khai",
      note:"Náº¿u máº¡ng khÃ´ng cÃ³ IPv4/IPv6 cÃ´ng cá»™ng, bÃªn tÆ°Æ¡ng á»©ng cÃ³ thá»ƒ trá»‘ng.",
      lanTip:"TrÃ¬nh duyá»‡t áº©n IP ná»™i bá»™; chá»‰ thá»­ WebRTC.", lanTrying:"Äang thá»­â€¦", lanFail:"KhÃ´ng cÃ³ (trÃ¬nh duyá»‡t cháº·n)"
  },
  bn:{title:"IPv4/IPv6 à¦…à¦¨à§à¦¸à¦¨à§à¦§à¦¾à¦¨ | GoToolOnline",desc:"à¦ªà¦¾à¦¬à¦²à¦¿à¦• IPv4/IPv6 à¦à¦¬à¦‚ à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨ (à¦¦à§‡à¦¶/à¦…à¦à§à¦šà¦²/à¦¶à¦¹à¦°/ISP) à¦¦à§‡à¦–à¦¾à¦¯à¦¼à¥¤",h1:"IPv4 / IPv6 à¦…à¦¨à§à¦¸à¦¨à§à¦§à¦¾à¦¨",
      btnBoth:"à¦†à¦®à¦¾à¦° IP à¦¦à§‡à¦–à¦¾à¦¨ (v4+v6)",btnCopy4:"IPv4 à¦•à¦ªà¦¿",btnCopy6:"IPv6 à¦•à¦ªà¦¿",btnLan:"à¦²à§‹à¦•à¦¾à¦² IPv4 à¦šà§‡à¦·à§à¦Ÿà¦¾ (à¦ªà¦°à§€à¦•à§à¦·à¦¾à¦®à§‚à¦²à¦•)",
      v4:"à¦ªà¦¾à¦¬à¦²à¦¿à¦• IPv4", v6:"à¦ªà¦¾à¦¬à¦²à¦¿à¦• IPv6", lan:"à¦²à§‹à¦•à¦¾à¦² IPv4 (à¦ªà¦°à§€à¦•à§à¦·à¦¾à¦®à§‚à¦²à¦•)",
      copied:"à¦•à¦ªà¦¿ à¦¹à¦¯à¦¼à§‡à¦›à§‡!", checking:"à¦šà§‡à¦• à¦•à¦°à¦¾ à¦¹à¦šà§à¦›à§‡â€¦", no4:"à¦ªà¦¾à¦¬à¦²à¦¿à¦• IPv4 à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿", no6:"à¦ªà¦¾à¦¬à¦²à¦¿à¦• IPv6 à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿",
      note:"à¦¨à§‡à¦Ÿà¦“à¦¯à¦¼à¦¾à¦°à§à¦•à§‡ IPv4/IPv6 à¦¨à¦¾ à¦¥à¦¾à¦•à¦²à§‡ à¦¸à¦‚à¦¶à§à¦²à¦¿à¦·à§à¦Ÿ à¦¦à¦¿à¦• à¦–à¦¾à¦²à¦¿ à¦¥à¦¾à¦•à¦¬à§‡à¥¤",
      lanTip:"à¦¬à§à¦°à¦¾à¦‰à¦œà¦¾à¦° à¦²à§‹à¦•à¦¾à¦² IP à¦²à§à¦•à¦¾à¦¯à¦¼; WebRTC à¦šà§‡à¦·à§à¦Ÿà¦¾ à¦®à¦¾à¦¤à§à¦°à¥¤", lanTrying:"à¦šà§‡à¦·à§à¦Ÿà¦¾ à¦šà¦²à¦›à§‡â€¦", lanFail:"à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿ (à¦¬à§à¦°à¦¾à¦‰à¦œà¦¾à¦° à¦¬à§à¦²à¦•)"
  },
  ng:{title:"IPv4/IPv6 Lookup | GoToolOnline",desc:"Show public IPv4/IPv6 and rough location (country/region/city/ISP).",h1:"IPv4 / IPv6 Lookup",
      btnBoth:"Show My IPs (v4+v6)",btnCopy4:"Copy IPv4",btnCopy6:"Copy IPv6",btnLan:"Try Local IPv4 (Experimental)",
      v4:"Public IPv4", v6:"Public IPv6", lan:"Local IPv4 (Experimental)",
      copied:"Copied!", checking:"Checkingâ€¦", no4:"No public IPv4 (mobile/CGNAT common)", no6:"No public IPv6",
      note:"If your network lacks IPv4/IPv6, that side may be empty.",
      lanTip:"Local IP is hidden; WebRTC probe only.", lanTrying:"Tryingâ€¦", lanFail:"Not available (blocked)"
  },
  sw:{title:"Utafutaji wa IPv4/IPv6 | GoToolOnline",desc:"Onyesha IPv4/IPv6 ya umma na eneo (nchi/mkoa/jiji/ISP).",h1:"Utafutaji wa IPv4 / IPv6",
      btnBoth:"Onyesha IP Zangu (v4+v6)",btnCopy4:"Nakili IPv4",btnCopy6:"Nakili IPv6",btnLan:"Jaribu IPv4 ya Ndani (Majaribio)",
      v4:"IPv4 ya Umma", v6:"IPv6 ya Umma", lan:"IPv4 ya Ndani (Majaribio)",
      copied:"Imenakiliwa!", checking:"Inakaguliwaâ€¦", no4:"Hakuna IPv4 ya umma", no6:"Hakuna IPv6 ya umma",
      note:"Kama mtandao hauna IPv4/IPv6, upande huo unaweza kuwa mtupu.",
      lanTip:"Kivinjari huficha IP ya ndani; jaribio la WebRTC pekee.", lanTrying:"Inajaribuâ€¦", lanFail:"Haipatikani (imezuiwa)"
  },
  ar:{title:"Ø¨Ø­Ø« IPv4/IPv6 | GoToolOnline",desc:"Ø§Ø¹Ø±Ø¶ IPv4/IPv6 Ø§Ù„Ø¹Ø§Ù… ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ (Ø¨Ù„Ø¯/Ù…Ù†Ø·Ù‚Ø©/Ù…Ø¯ÙŠÙ†Ø©/Ù…Ø²ÙˆØ¯).",h1:"Ø¨Ø­Ø« IPv4 / IPv6",
      btnBoth:"Ø§Ø¹Ø±Ø¶ Ø¹Ù†Ø§ÙˆÙŠÙ†ÙŠ (v4+v6)",btnCopy4:"Ø§Ù†Ø³Ø® IPv4",btnCopy6:"Ø§Ù†Ø³Ø® IPv6",btnLan:"Ù…Ø­Ø§ÙˆÙ„Ø© IPv4 Ø§Ù„Ù…Ø­Ù„ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ)",
      v4:"IPv4 Ø§Ù„Ø¹Ø§Ù…", v6:"IPv6 Ø§Ù„Ø¹Ø§Ù…", lan:"IPv4 Ø§Ù„Ù…Ø­Ù„ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ)",
      copied:"ØªÙ… Ø§Ù„Ù†Ø³Ø®!", checking:"Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦", no4:"ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IPv4 Ø§Ù„Ø¹Ø§Ù… (CGNAT/Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø¬ÙˆØ§Ù„)", no6:"ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IPv6 Ø§Ù„Ø¹Ø§Ù…",
      note:"Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´Ø¨ÙƒØ© Ù„Ø§ ØªÙ…Ù„Ùƒ IPv4/IPv6 Ø¹Ø§Ù…ØŒ ÙÙ‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ ÙØ§Ø±ØºÙ‹Ø§.",
      lanTip:"Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ®ÙÙŠ IP Ø§Ù„Ù…Ø­Ù„ÙŠØ› Ù…Ø¬Ø±Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© WebRTC.", lanTrying:"Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©â€¦", lanFail:"ØºÙŠØ± Ù…ØªØ§Ø­ (Ù…Ø­Ø¬ÙˆØ¨)"
  }
};

function mapHtmlLang(lang){
  if (lang === 'ph') return 'fil';
  if (lang === 'zh') return 'zh-CN';
  if (lang === 'ng') return 'en-NG';
  return lang;
}
function tkey(k){ const lang=$('#lang').value; return (I18N[lang]||I18N.zh)[k]||I18N.zh[k]||k; }
function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }
function applyLang(lang){
  const d=I18N[lang]||I18N.zh;
  document.title=d.title;
  const md=document.querySelector('meta[name="description"]'); if(md) md.setAttribute('content', d.desc);
  document.documentElement.lang=mapHtmlLang(lang);
  document.documentElement.dir=(lang==='ar')?'rtl':'ltr';
  $('#lang').value=lang;
  setText('h1', d.h1);
  setText('btnBoth', d.btnBoth); setText('btnCopy4', d.btnCopy4); setText('btnCopy6', d.btnCopy6); setText('btnLan', d.btnLan);
  setText('labelV4', d.v4); setText('labelV6', d.v6); setText('labelLan', d.lan);
  setText('note', d.note); setText('lanTip', d.lanTip);
  localStorage.setItem('lang', lang);
  const qs=new URLSearchParams(location.search); qs.set('lang', lang);
  history.replaceState({},'',location.pathname+'?'+qs.toString());
}
function bootLang(){
  const qs=new URLSearchParams(location.search);
  const fromQS=qs.get('lang'); const fromLS=localStorage.getItem('lang');
  applyLang(I18N[fromQS]?fromQS:(I18N[fromLS]?fromLS:'zh'));
}

/* ===================== IPv4 / IPv6 è·å– ===================== */
/* v4ï¼šå¤šæºå¹¶è¡Œï¼ˆå«å›½å†…å¯ç”¨æºä¸ºå…œåº•ï¼‰ */
async function getIPv4(){
  // å›½å†…å…œåº•ï¼ˆJSONPï¼‰
  const sohu = new Promise((resolve)=>{
    const prev=window.returnCitySN;
    const s=document.createElement('script');
    s.src='https://pv.sohu.com/cityjson?ie=utf-8';
    s.onload=()=>{ 
      try{
        const d=window.returnCitySN;
        if(prev===undefined){ try{delete window.returnCitySN;}catch(e){} } else window.returnCitySN=prev;
        const ip=d&&d.cip?String(d.cip):'';
        if(IPV4_RE.test(ip)) resolve({ip, hint:d.cname||''});
      }catch(e){/* ignore */}
    };
    s.onerror=()=>{};
    document.head.appendChild(s);
    setTimeout(()=>resolve(null), TIMEOUT);
  });

  const reqs = [
    abortableFetchJSON('https://api4.ipify.org?format=json').then(j=>j&&IPV4_RE.test(j.ip)?{ip:j.ip}:null),
    abortableFetchJSON('https://ipv4.seeip.org/json').then(j=>j&&IPV4_RE.test(j.ip)?{ip:j.ip}:null),
    abortableFetchJSON('https://v4.ident.me/.json').then(j=>j&&IPV4_RE.test(j.address)?{ip:j.address}:null),
    sohu
  ];

  try{
    const r = await Promise.any(reqs.map(p=>p.then(x=>{ if(!x) throw 0; return x; })));
    if(r && r.ip) return r;
    throw new Error('no ipv4');
  }catch{ throw new Error('no ipv4'); }
}

/* v6ï¼šå¤šæºå¹¶è¡Œ */
async function getIPv6(){
  const reqs = [
    abortableFetchJSON('https://api64.ipify.org?format=json').then(j=>j&&j.ip&&j.ip.includes(':')?{ip:j.ip}:null),
    abortableFetchJSON('https://api6.ipify.org?format=json').then(j=>j&&j.ip&&j.ip.includes(':')?{ip:j.ip}:null),
    abortableFetchJSON('https://ipv6.seeip.org/json').then(j=>j&&j.ip&&j.ip.includes(':')?{ip:j.ip}:null),
  ];
  try{
    const r = await Promise.any(reqs.map(p=>p.then(x=>{ if(!x) throw 0; return x; })));
    if(r && r.ip) return r;
    throw new Error('no ipv6');
  }catch{ throw new Error('no ipv6'); }
}

/* åœ°ç†ä¿¡æ¯ï¼šä¼˜å…ˆ ipinfo(token) â†’ ipapi â†’ ip-api(JSONP) */
async function geoByIP(ip){
  if(!ip) return null;

  const ipinfoUrl = CFG.ipinfoToken
      ? `https://api.ipinfo.io/${encodeURIComponent(ip)}?token=${encodeURIComponent(CFG.ipinfoToken)}`
      : `https://api.ipinfo.io/${encodeURIComponent(ip)}`;
  const ipinfo = abortableFetchJSON(ipinfoUrl).then(j=>{
    if(!j) throw 0;
    return { cc:j.country||'', city:j.city||'', region:j.region||'', org:j.org||'' };
  });

  const ipapiUrl = CFG.ipapiKey
      ? `https://ipapi.co/${encodeURIComponent(ip)}/json/?key=${encodeURIComponent(CFG.ipapiKey)}`
      : `https://ipapi.co/${encodeURIComponent(ip)}/json/`;
  const ipapi = abortableFetchJSON(ipapiUrl).then(j=>{
    if(!j) throw 0;
    return { cc:j.country||j.country_code||'', city:j.city||'', region:j.region||'', org:j.org||j.org_name||'' };
  });

  const ipapijsonp = new Promise((resolve)=>{
    const cb='__jp'+Math.random().toString(36).slice(2);
    window[cb]=(d)=>{ try{ delete window[cb]; }catch(e){} resolve(d); };
    const s=document.createElement('script');
    s.src=`https://ip-api.com/json/${encodeURIComponent(ip)}?fields=status,country,countryCode,regionName,city,isp&callback=${cb}`;
    s.onerror=()=>resolve(null);
    document.head.appendChild(s);
    setTimeout(()=>resolve(null), TIMEOUT);
  }).then(d=>{
    if(d && d.status==='success'){
      return { cc:d.countryCode||'', city:d.city||'', region:d.regionName||'', org:d.isp||'' };
    }
    throw 0;
  });

  try{
    return await Promise.any([ipinfo, ipapi, ipapijsonp]);
  }catch{
    return null;
  }
}

/* ===================== äº¤äº’é€»è¾‘ ===================== */
function t(k){ return tkey(k); }

async function showBoth(){
  // v4
  setText('ip4', t('checking')); setText('geo4txt','â€”'); setText('flag4','ğŸ³ï¸');
  try{
    const r4=await getIPv4(); setText('ip4', r4.ip);
    try{
      const g4=await geoByIP(r4.ip);
      if(g4){
        const parts=[g4.city, g4.region, g4.cc].filter(Boolean);
        setText('geo4txt', (parts.length?parts.join(', '):'â€”') + (g4.org?(' Â· '+g4.org):''));
        setText('flag4', ccToFlag(g4.cc));
      }else if(r4.hint){
        setText('geo4txt', r4.hint);
      }
    }catch{}
  }catch{ setText('ip4', t('no4')); }

  // v6
  setText('ip6', t('checking')); setText('geo6txt','â€”'); setText('flag6','ğŸ³ï¸');
  try{
    const r6=await getIPv6(); setText('ip6', r6.ip);
    try{
      const g6=await geoByIP(r6.ip);
      if(g6){
        const parts=[g6.city, g6.region, g6.cc].filter(Boolean);
        setText('geo6txt', (parts.length?parts.join(', '):'â€”') + (g6.org?(' Â· '+g6.org):''));
        setText('flag6', ccToFlag(g6.cc));
      }
    }catch{}
  }catch{ setText('ip6', t('no6')); }
}

function copyText(idTip, ipStr, isV6=false){
  const v = (ipStr||'').trim();
  if(!v) return;
  if(!isV6 && !IPV4_RE.test(v)) return;
  if(isV6 && !(IPV6_RE.test(v) && v.includes(':'))) return;
  navigator.clipboard?.writeText(v).then(()=>{
    const el=$(idTip); el.textContent=t('copied'); el.style.display='';
    setTimeout(()=>el.style.display='none', 1200);
  }).catch(()=>{});
}

// Local IPv4 via WebRTCï¼ˆæˆåŠŸç‡ä½ï¼ŒæŒ‰ä½ çš„åŸè®¾è®¡ä¿ç•™ï¼‰
async function detectLAN(){
  setText('lan', t('lanTrying'));
  try{
    const pc=new RTCPeerConnection({iceServers:[]}); pc.createDataChannel('x');
    const found=new Set(); const stop=()=>{ try{pc.close();}catch(e){} };
    const timer=setTimeout(()=>{ stop(); if($('#lan').textContent===t('lanTrying')) setText('lan', t('lanFail')); }, 7000);
    pc.onicecandidate=(e)=>{
      if(!e.candidate) return;
      const c=e.candidate.candidate||''; if(!/ typ host\\b/.test(c)) return;
      const m=c.match(/(\\d{1,3}(?:\\.\\d{1,3}){3})/); if(!m) return;
      const ip=m[1];
      if(/^10\\./.test(ip)||/^192\\.168\\./.test(ip)||/^172\\.(1[6-9]|2\\d|3[0-1])\\./.test(ip)){
        if(!found.has(ip)){ found.add(ip); setText('lan', ip); clearTimeout(timer); stop(); }
      }
    };
    const sdp=await pc.createOffer({offerToReceiveAudio:false,offerToReceiveVideo:false}); await pc.setLocalDescription(sdp);
  }catch(e){ setText('lan', t('lanFail')); }
}

/* è¯­è¨€ & äº‹ä»¶ç»‘å®š */
function onReady(){
  bootLang();
  $('#lang').addEventListener('change', e=>applyLang(e.target.value));
  $('#btnBoth').addEventListener('click', showBoth);
  $('#btnCopy4').addEventListener('click', ()=>copyText('#copied4', $('#ip4').textContent, false));
  $('#btnCopy6').addEventListener('click', ()=>copyText('#copied6', $('#ip6').textContent, true));
  $('#btnLan').addEventListener('click', detectLAN);
  showBoth(); // è‡ªåŠ¨è¿è¡Œä¸€æ¬¡
  // ä¿ç•™ä½ çš„ home é“¾æ¥é€»è¾‘ï¼ˆå¸¦ langï¼‰
  (function(){
    var path = location.pathname.replace(/\/+$/,'');
    var parts = path.split('/');
    if (parts.length >= 3) parts = parts.slice(0, parts.length - 2);
    else parts = [''];
    var home = parts.join('/') + '/';
    var cur = new URL(location.href);
    var lang = cur.searchParams.get('lang') || localStorage.getItem('lang');
    if (lang) {
      var u = new URL(home, location.origin);
      u.searchParams.set('lang', lang);
      home = u.pathname + u.search + u.hash;
    }
    document.querySelectorAll('a[data-home]').forEach(function(a){
      a.setAttribute('href', home);
    });
  })();
}
document.addEventListener('DOMContentLoaded', onReady);
</script>
</body>
</html>
